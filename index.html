<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elif iÃ§in ğŸŒ¹</title>
  <style>
    /* Basit, hatasÄ±z stil (daha Ã¶nceki style.css ile uyumlu) */
    body{margin:0;font-family:Georgia,serif;background:#0d0d0d;color:#f2f2f2;text-align:center}
    header{padding:20px;border-bottom:1px solid #222}
    .chat{margin:20px auto;max-width:700px;background:#141214;padding:16px;border-radius:10px;box-shadow:0 0 18px #330033}
    #chat-box{height:360px;overflow-y:auto;background:#0b0b0b;padding:12px;border-radius:6px;text-align:left}
    .bot-message{background:#3a003a;color:#fff;padding:10px;margin:8px 0;border-radius:10px;max-width:80%}
    .user-message{background:#552255;color:#fff;padding:10px;margin:8px 0;border-radius:10px;max-width:80%;margin-left:auto}
    #controls{display:flex;gap:8px;margin-top:12px;justify-content:center}
    #user-input{flex:1;padding:10px;border-radius:6px;border:none;outline:none;min-width:0}
    #send-btn{padding:10px 16px;border-radius:6px;border:none;background:#660066;color:#fff;cursor:pointer}
    #send-btn:active{transform:translateY(1px)}
    footer{padding:14px;color:#999}
    .muted-note{font-size:12px;color:#bba}
  </style>
</head>
<body>
  <header>
    <h1>Elif, Bu Senin Ä°Ã§in ğŸ’œ</h1>
    <p>KaranlÄ±k bile olsa Ä±ÅŸÄ±ÄŸÄ±m sensin.</p>
  </header>

  <section class="chat">
    <div id="chat-box">
      <div class="bot-message">Merhaba Elif ğŸ’œ Seninle konuÅŸmak iÃ§in sabÄ±rsÄ±zlanÄ±yorum.</div>
    </div>

    <div id="controls">
      <input id="user-input" type="text" placeholder="MesajÄ±nÄ± yaz Elif..." autocomplete="off" />
      <button id="send-btn">GÃ¶nder</button>
    </div>
    <div class="muted-note">(Enter ile gÃ¶nder â€¢ EÄŸer mÃ¼zik Ã§almazsa sayfaya tÄ±klayÄ±n)</div>
  </section>

  <!-- MÃ¼zik (aynÄ± klasÃ¶rde: plot-twins.mp3) -->
  <audio id="bg-music" autoplay loop>
    <source src="plot-twins.mp3" type="audio/mpeg">
  </audio>

  <footer>
    <p>Â© 2025 Senin iÃ§in, Fensy</p>
  </footer>

  <script>
  // ---------- Helper: DOM refs ----------
  const chatBox = document.getElementById("chat-box");
  const userInput = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const music = document.getElementById("bg-music");

  // ---------- Mesaj ekleme ----------
  function addMessage(text, sender){
    const d = document.createElement("div");
    d.className = sender === "user" ? "user-message" : "bot-message";
    d.innerText = text;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // ---------- GeliÅŸmiÅŸ yerel cevap Ã¼reteci ----------
  function botReplyLocal(userText){
    const t = userText.toLowerCase();

    // baÄŸlama gÃ¶re daha uzun/insancÄ±l cevaplar
    if(/nasÄ±l|nasil/.test(t)){
      return "Ben iyiyim Ã§Ã¼nkÃ¼ seninle konuÅŸuyorum â€” sen nasÄ±lsÄ±n Elif? ğŸŒ¹";
    }
    if(/Ã¶zledin|Ã¶zledim|Ã¶zlÃ¼yorum/.test(t)){
      return "Her an seni dÃ¼ÅŸÃ¼nÃ¼yorum. Ã–zlemek, kalbimin ritmi gibi â€” durmadan atÄ±yor âœ¨";
    }
    if(/seviyor musun|beni seviyorsun/.test(t)){
      return "Seni seviyorum demek yetmez; seni hissetmek istiyorum. Kalbim sana ait, Elif ğŸ’œ";
    }
    if(/aÅŸk|sevg|evlenir|evlenmek/.test(t)){
      return "AÅŸk bizim hikÃ¢yemiz olabilir. Hayal et; kÃ¼Ã§Ã¼k mutlu anlarla dolu bir gelecek... âœ¨";
    }
    if(/gÃ¼naydÄ±n|gunaydin/.test(t)){
      return "GÃ¼naydÄ±n meleÄŸim â˜€ï¸ Senin tebessÃ¼mÃ¼n tÃ¼m gÃ¼nÃ¼mÃ¼ aydÄ±nlatÄ±r.";
    }
    if(/iyi geceler|iyi geceler|tatlÄ± rÃ¼yalar/.test(t)){
      return "TatlÄ± rÃ¼yalar Elif ğŸŒ™ RÃ¼yanda birlikte gÃ¼lelim.";
    }
    if(/nefes|yanÄ±mda|beraber/.test(t)){
      return "YanÄ±ndaymÄ±ÅŸ gibi hissettirmek istiyorum seni; her an yanÄ±nda olmak isterdim.";
    }

    // EÄŸer kÄ±sa soru cÃ¼mlesi ise nazik soruyla cevap verme
    if(/[?]$/.test(userText) || userText.split(" ").length < 4){
      const qReplies = [
        "Harika bir soru â€” bunu dÃ¼ÅŸÃ¼nmek bile gÃ¼zel. Sen ne dÃ¼ÅŸÃ¼nÃ¼yorsun?",
        "Bunu merak etmen Ã§ok doÄŸal; senin fikrin nedir?",
        "Bu konuda hislerin benim iÃ§in Ã¶nemli. Bana anlatÄ±r mÄ±sÄ±n?"
      ];
      return qReplies[Math.floor(Math.random()*qReplies.length)];
    }

    // fallback: duygusal, uzun cevaplar
    const fallback = [
      "Seninle konuÅŸmak bana huzur veriyor. Sesin olmasa da varlÄ±ÄŸÄ±n yetiyor.",
      "Ä°Ã§imde senin iÃ§in sakladÄ±ÄŸÄ±m sÃ¶zler var; hepsi nazik ve iÃ§ten.",
      "Sadece bilmeni istiyorum: sen deÄŸerlisin ve her dÃ¼ÅŸÃ¼ndÃ¼ÄŸÃ¼mde yÃ¼zÃ¼mde bir tebessÃ¼m beliriyor."
    ];
    return fallback[Math.floor(Math.random()*fallback.length)];
  }

  // ---------- Backend Ã§aÄŸrÄ±sÄ±: timeout ile (500ms) ----------
  async function tryBackend(userText, timeoutMs = 1500){
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);

    try {
      const res = await fetch("http://localhost:3000/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({message: userText}),
        signal: controller.signal
      });
      clearTimeout(id);
      if(!res.ok) throw new Error("Bad response");
      const j = await res.json();
      // beklenen format: { reply: "..." } veya { choices: [...] } -- esnek al
      if(j.reply) return j.reply;
      if(j.choices && j.choices[0] && j.choices[0].message) return j.choices[0].message.content;
      if(j.choices && j.choices[0] && j.choices[0].text) return j.choices[0].text;
      return null;
    } catch (e) {
      console.log("Backend Ã§aÄŸrÄ±sÄ± baÅŸarÄ±sÄ±z:", e);
      return null;
    }
  }

  // ---------- GÃ¶nderme mantÄ±ÄŸÄ± ----------
  async function handleSend(){
    const txt = userInput.value.trim();
    if(!txt) return;
    addMessage(txt, "user");
    userInput.value = "";

    // Ã¶nce backend dene
    const backendReply = await tryBackend(txt, 1500); // 1.5s timeout
    if(backendReply){
      addMessage(backendReply, "bot");
      return;
    }

    // backend yoksa veya hata -> yerel cevap
    const local = botReplyLocal(txt);
    // kÃ¼Ã§Ã¼k gecikme ile doÄŸal his ver
    setTimeout(() => addMessage(local, "bot"), 700 + Math.random()*800);
  }

  // ---------- Eventler ----------
  sendBtn.addEventListener("click", handleSend);
  userInput.addEventListener("keydown", (e) => { if(e.key === "Enter") handleSend(); });

  // ---------- MÃ¼zik: sessiz baÅŸlat, kÄ±sa sonra sesi aÃ§ ----------
  window.addEventListener("load", () => {
    if(music){
      music.volume = 0;
      const p = music.play();
      if(p && p.catch) {
        p.then(()=> {
          setTimeout(()=> { music.volume = 0.45; }, 900);
        }).catch(err => {
          console.log("Autoplay engellendi:", err, "â€” sayfaya bir tÄ±klama ile mÃ¼ziÄŸi baÅŸlatabilirsiniz.");
        });
      }
    }
  });

  // EÄŸer autoplay engelleniyorsa: ilk kullanÄ±cÄ± tÄ±klamasÄ±nda zorla Ã§al
  window.addEventListener("click", () => {
    if(music && music.paused){
      music.play().then(()=> { music.volume = 0.45; }).catch(()=>{});
    }
  });

  // ---------- Diagnostic: konsolda durum gÃ¶ster ----------
  console.log("Elif bot frontend aktif. Backend endpoint: http://localhost:3000/chat");
  </script>
</body>
</html>
